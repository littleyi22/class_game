<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å¥•éˆè€å¸«çš„åœ‹æ–‡èª² v7.0</title>
    <style>
        :root {
            --glass-bg: rgba(255, 255, 255, 0.75);
            --glass-border: 1px solid rgba(255, 255, 255, 0.8);
            --glass-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.1);
            --primary: #007AFF;
            --danger: #FF3B30;
            --success: #34C759;
            --text: #1d1d1f;
            --text-sec: #6e6e73;
        }

        * { box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; -webkit-tap-highlight-color: transparent; }
        
        body { 
            margin: 0; padding: 0; 
            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); 
            height: 100vh; /* å›ºå®šé«˜åº¦ */
            width: 100vw;
            color: var(--text); 
            display: flex; flex-direction: column; overflow: hidden; /* é˜²æ­¢æ•´é æ²å‹• */
        }

        /* èƒŒæ™¯æ°£æ³¡ */
        .bg-blobs { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; pointer-events: none; }
        .blob { position: absolute; border-radius: 50%; filter: blur(60px); opacity: 0.6; animation: float 10s infinite ease-in-out; }
        .blob-1 { top: -10%; left: -10%; width: 50vw; height: 50vw; background: #fff1eb; animation-duration: 12s; }
        .blob-2 { bottom: -10%; right: -10%; width: 60vw; height: 60vw; background: #a8edea; animation-duration: 15s; }
        @keyframes float { 0%, 100% { transform: translate(0, 0); } 50% { transform: translate(20px, -20px); } }

        /* Glass Style */
        .glass {
            background: var(--glass-bg);
            backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
            border: var(--glass-border); box-shadow: var(--glass-shadow);
            border-radius: 20px;
        }

        /* HEADER */
        header { padding: 1rem; display: flex; justify-content: space-between; align-items: center; z-index: 100; margin: 10px; border-radius: 24px; flex-shrink: 0; }
        .brand { font-size: 1.1rem; font-weight: 800; display: flex; align-items: center; gap: 8px; }
        .controls { display: flex; gap: 8px; }

        /* BUTTONS */
        .btn {
            border: none; padding: 10px 16px; border-radius: 12px; font-weight: 600; font-size: 0.95rem;
            cursor: pointer; transition: 0.2s; display: flex; align-items: center; justify-content: center; gap: 5px;
            background: rgba(255,255,255,0.6); color: var(--text); box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .btn:active { transform: scale(0.96); background: rgba(255,255,255,0.9); }
        .btn.primary { background: var(--primary); color: white; }
        .btn.danger { background: var(--danger); color: white; }
        .btn.success { background: var(--success); color: white; }

        /* NAV */
        nav { display: flex; justify-content: center; gap: 8px; padding: 0 10px; margin-bottom: 5px; flex-shrink: 0; z-index: 90; }
        .nav-item {
            padding: 10px 30px; border: none; background: rgba(255,255,255,0.4); 
            font-weight: 600; color: var(--text-sec); cursor: pointer; border-radius: 14px;
            transition: 0.2s;
        }
        .nav-item.active { background: white; color: var(--primary); box-shadow: 0 4px 10px rgba(0,0,0,0.1); transform: translateY(-2px); }

        /* MAIN SCROLL AREA (ä¿®æ­£æ²å‹•å•é¡Œ) */
        main { 
            flex: 1; 
            overflow-y: auto; /* å…è¨±å‚ç›´æ²å‹• */
            -webkit-overflow-scrolling: touch; /* iOS æ»‘å‹•æ…£æ€§ */
            padding: 10px; padding-bottom: 100px;
            position: relative; z-index: 10; 
        }
        
        .view-section { display: none; }
        .view-section.active { display: block; animation: fadeIn 0.3s; }

        /* DASHBOARD */
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px; }
        .group-card { display: flex; flex-direction: column; overflow: hidden; position: relative; }
        .group-header { padding: 12px; border-bottom: 1px solid rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center; }
        .score-display { font-size: 1.4rem; font-weight: 800; color: var(--primary); min-width: 40px; text-align: center; }
        .btn-circle {
            width: 32px; height: 32px; border-radius: 50%; border: none; cursor: pointer;
            display: flex; align-items: center; justify-content: center; font-size: 1.2rem; font-weight: bold;
            background: white; color: var(--text); box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .member-list { padding: 10px; }
        .member-row { display: flex; justify-content: space-between; align-items: center; padding: 6px 0; border-bottom: 1px solid rgba(0,0,0,0.03); }

        /* BUZZER CONTROLLER (åµŒå…¥é¦–é ) */
        .buzzer-panel {
            margin-bottom: 20px; padding: 15px; text-align: center;
            border-left: 5px solid var(--primary);
        }
        .buzzer-actions { display: flex; gap: 10px; justify-content: center; margin-top: 10px; }
        
        /* ADMIN BOX */
        .admin-box { margin-bottom: 20px; padding: 20px; position: relative; z-index: 20; }
        .form-control {
            width: 100%; padding: 12px; border: 1px solid rgba(0,0,0,0.1); background: rgba(255,255,255,0.6);
            border-radius: 12px; font-size: 1rem; outline: none; margin-bottom: 10px;
        }
        .manual-group-item { background: rgba(255,255,255,0.5); padding: 15px; border-radius: 16px; margin-bottom: 15px; border: 1px solid rgba(255,255,255,0.6); }

        /* BUZZER STUDENT SCREEN */
        #student-buzzer-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 2000;
            display: none; flex-direction: column; justify-content: center; align-items: center;
            background: rgba(255,255,255,0.95);
        }
        .buzzer-btn-main {
            width: 200px; height: 200px; border-radius: 50%; border: 8px solid rgba(255,255,255,0.5);
            background: linear-gradient(135deg, #FF3B30 0%, #FF2D55 100%);
            box-shadow: 0 15px 35px rgba(255, 59, 48, 0.4); color: white; font-size: 2rem; font-weight: 800;
            cursor: pointer; display: none;
        }
        .buzzer-btn-main:active { transform: scale(0.95); }

        /* MODALS & UTILS */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4);
            backdrop-filter: blur(8px); display: none; justify-content: center; align-items: center; z-index: 3000;
        }
        .modal-overlay.open { display: flex; animation: fadeIn 0.2s; }
        .modal { width: 90%; max-width: 380px; padding: 30px; text-align: center; box-shadow: 0 20px 40px rgba(0,0,0,0.2); }
        .admin-only { display: inherit; }
        body.mode-guest .admin-only { display: none !important; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.98); } to { opacity: 1; transform: scale(1); } }
        
        #toast {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8); color: white; padding: 10px 20px; border-radius: 30px;
            font-size: 0.9rem; pointer-events: none; opacity: 0; transition: 0.3s; z-index: 5000;
        }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; background: #ccc; box-shadow: 0 0 5px #ccc;}
        .status-dot.ok { background: var(--success); box-shadow: 0 0 8px var(--success); }
    </style>
</head>
<body>

<div class="bg-blobs">
    <div class="blob blob-1"></div>
    <div class="blob blob-2"></div>
</div>

<!-- LOGIN -->
<div id="login-overlay" style="position:fixed; top:0; left:0; width:100%; height:100%; z-index:9999; display:flex; justify-content:center; align-items:center; background:rgba(255,255,255,0.6); backdrop-filter:blur(20px);">
    <div class="glass modal">
        <h2 style="margin-top:0;">ğŸ”’ èª²å ‚ç™»å…¥</h2>
        <input type="password" id="password-input" class="form-control" placeholder="è€å¸«å¯†ç¢¼ (é è¨­: 1234)" style="text-align:center;">
        <button class="btn primary" style="width:100%; margin-top:10px; padding:14px;" onclick="app.auth.loginAdmin()">æˆ‘æ˜¯è€å¸«</button>
        <div style="margin-top:20px; padding-top:20px; border-top:1px solid rgba(0,0,0,0.1);">
            <button class="btn" style="width:100%; background:white;" onclick="app.auth.loginGuest()">æˆ‘æ˜¯å­¸ç”Ÿ (è¨ªå®¢)</button>
        </div>
    </div>
</div>

<!-- STUDENT SELECT -->
<div id="modal-guest-select" class="modal-overlay">
    <div class="glass modal">
        <h3>ğŸ‘‹ é¸æ“‡çµ„åˆ¥</h3>
        <div id="guest-group-list" style="display:flex; flex-direction:column; gap:10px; max-height:300px; overflow-y:auto; margin-top:10px;"></div>
    </div>
</div>

<!-- BUZZER SCREEN -->
<div id="student-buzzer-screen">
    <h1 id="buzzer-status-text">ç­‰å¾…æŒ‡ä»¤...</h1>
    <p>æ‚¨çš„çµ„åˆ¥: <strong id="my-group-name">--</strong></p>
    <button id="buzzer-btn" class="buzzer-btn-main" onclick="app.buzzer.studentBuzz()">æ¶ç­”!</button>
    <button class="btn" style="margin-top:50px;" onclick="app.buzzer.exitStudentMode()">é›¢é–‹</button>
</div>

<header class="glass">
    <div class="brand">
        <span>ğŸ“š å¥•éˆè€å¸«çš„åœ‹æ–‡èª²</span>
        <div class="status-dot" id="conn-dot"></div>
    </div>
    <div class="controls admin-only">
        <button class="btn" onclick="app.toggleLink()">é€£å‹• <strong id="link-status" style="margin-left:5px;">ON</strong></button>
        <button class="btn" onclick="app.toggleSound()">éŸ³æ•ˆ</button>
    </div>
</header>

<nav class="admin-only">
    <button id="nav-dashboard" class="nav-item active" onclick="app.switchView('dashboard')">åˆ†çµ„èˆ‡æ¶ç­”</button>
    <button id="nav-admin" class="nav-item" onclick="app.switchView('admin')">å¾Œå°è¨­å®š</button>
</nav>

<main>
    <!-- 1. DASHBOARD & BUZZER (Merged) -->
    <section id="view-dashboard" class="view-section active">
        
        <!-- BUZZER CONTROL PANEL (Admin Only) -->
        <div class="glass buzzer-panel admin-only">
            <h3 style="margin:0; display:flex; justify-content:center; align-items:center; gap:10px;">
                ğŸš¨ æ¶ç­”æ§åˆ¶ 
                <span id="admin-buzzer-state" style="font-size:0.8rem; background:#eee; padding:2px 8px; border-radius:10px;">IDLE</span>
            </h3>
            <div class="buzzer-actions">
                <button class="btn" style="background:#FFD60A;" onclick="app.buzzer.set('ready')">âœ‹ é å‚™</button>
                <button class="btn success" onclick="app.buzzer.set('go')">ğŸš€ é–‹å§‹</button>
                <button class="btn danger" onclick="app.buzzer.set('idle')">ğŸ›‘ é‡ç½®</button>
            </div>
            <!-- Results Area -->
            <div id="buzzer-rank-list" style="margin-top:15px; font-weight:600; min-height:20px; color:var(--primary);"></div>
        </div>

        <!-- Groups Grid -->
        <div id="groups-container" class="dashboard-grid"></div>
    </section>

    <!-- 2. ADMIN SETTINGS -->
    <section id="view-admin" class="view-section admin-only">
        <!-- æ‰‹å‹•åˆ†çµ„ -->
        <div class="glass admin-box">
            <h3>ğŸ‘¥ æ‰‹å‹•åˆ†çµ„ç®¡ç†</h3>
            <div id="manual-group-container"></div>
            <button class="btn" style="width:100%; justify-content:center; margin-top:10px; border:1px dashed #aaa;" onclick="app.admin.addGroup()">+ æ–°å¢çµ„åˆ¥</button>
            <button class="btn primary" style="width:100%; justify-content:center; margin-top:20px; padding:12px; font-size:1rem;" onclick="app.admin.saveManualGroups()">ğŸ’¾ å„²å­˜æ‰€æœ‰è®Šæ›´</button>
        </div>

        <!-- å¿«é€Ÿåˆ†çµ„ -->
        <div class="glass admin-box">
            <h3>âš¡ å¿«é€Ÿéš¨æ©Ÿåˆ†çµ„</h3>
            <textarea id="bulk-names" class="form-control" placeholder="è²¼ä¸Šåå–® (ä¸€è¡Œä¸€å€‹)..."></textarea>
            <div style="display:flex; gap:10px;">
                <input type="number" id="group-count" value="6" class="form-control" style="width:80px; text-align:center;">
                <button class="btn" style="flex:1; justify-content:center;" onclick="app.admin.autoRandomGroup()">åŸ·è¡Œåˆ†çµ„</button>
            </div>
        </div>

        <!-- é›²ç«¯è¨­å®š -->
        <div class="glass admin-box">
            <h3>â˜ï¸ é€£ç·šè¨­å®š</h3>
            <div style="margin-bottom:10px; font-size:0.9rem; color:var(--text-sec);">
                GAS ç¶²å€ç‹€æ…‹: <span id="gas-url-status">ğŸ”´ å°šæœªè¨­å®š (è«‹åœ¨ç¨‹å¼ç¢¼æœ€å¾Œä¸€è¡Œè²¼ä¸Š)</span>
            </div>
            <button class="btn success" style="width:100%; justify-content:center;" onclick="app.sync.manualSync()">ç«‹å³æ‰‹å‹•åŒæ­¥</button>
            <button class="btn" style="width:100%; justify-content:center; margin-top:10px;" onclick="app.admin.exportCSV()">åŒ¯å‡º CSV</button>
        </div>
    </section>
</main>

<!-- FLOATING FAB -->
<div class="fab-container admin-only" style="position:fixed; bottom:30px; right:30px; z-index:200;">
    <div class="fab-menu" style="display:none; flex-direction:column; gap:10px; align-items:flex-end; margin-bottom:10px;">
        <button class="btn" onclick="app.lottery.start('group')">ğŸ° æŠ½å°çµ„</button>
        <button class="btn" onclick="app.lottery.start('person')">ğŸ‘¤ æŠ½å€‹äºº</button>
    </div>
    <button class="btn primary" style="width:60px; height:60px; border-radius:50%; font-size:24px; box-shadow:0 10px 20px rgba(0,0,0,0.2);" onclick="document.querySelector('.fab-menu').style.display = document.querySelector('.fab-menu').style.display=='flex'?'none':'flex'">ğŸ²</button>
</div>

<!-- WINNER MODAL -->
<div id="modal-winner" class="modal-overlay" onclick="this.classList.remove('open')">
    <div class="glass modal" onclick="event.stopPropagation()">
        <div style="font-size:4rem;">ğŸ‰</div>
        <h2 id="winner-name">---</h2>
        <button class="btn primary" onclick="document.getElementById('modal-winner').classList.remove('open')">æ­å–œï¼</button>
    </div>
</div>

<div id="toast">æ­¡è¿ä½¿ç”¨</div>

<script>
/**
 * å¥•éˆè€å¸«çš„åœ‹æ–‡èª² v7.0
 * 
 * ===============================================================
 * ğŸ“¢ è«‹å°‡æ‚¨çš„ Google Apps Script (GAS) ç¶²å€è²¼åœ¨ä¸‹æ–¹å¼•è™Ÿä¸­
 * ===============================================================
 */
const PRE_CONFIG_URL = "https://script.google.com/macros/s/AKfycbwtX0PXMlu2oksFO8IqUuRoywceloA0aDSpQ0QVxo-VW4a9i6uUlJxH4Oq1QqvhWSEc/exec"; 
// ç¯„ä¾‹ï¼š"https://script.google.com/macros/s/xxxxxxxxx/exec"


const AppState = {
    groups: [],
    buzzer: { state: 'idle', results: [] },
    settings: { linked: true, sound: true, gasUrl: PRE_CONFIG_URL, password: '1234' },
    userMode: 'guest',
    myGroup: null
};

const AudioSys = {
    ctx: null,
    playTone: function(freq, type, dur) {
        if (!AppState.settings.sound) return;
        try {
            if (!this.ctx) this.ctx = new (window.AudioContext || window.webkitAudioContext)();
            if (this.ctx.state === 'suspended') this.ctx.resume();
            const o = this.ctx.createOscillator(); const g = this.ctx.createGain();
            o.type = type; o.frequency.value = freq;
            g.gain.setValueAtTime(0.1, this.ctx.currentTime); g.gain.exponentialRampToValueAtTime(0.001, this.ctx.currentTime + dur);
            o.connect(g); g.connect(this.ctx.destination); o.start(); o.stop(this.ctx.currentTime + dur);
        } catch(e) { console.error(e); }
    },
    play: function(key) {
        if(AppState.userMode === 'guest' && key !== 'buzz') return; 
        switch(key) {
            case 'click': this.playTone(800, 'sine', 0.08); break;
            case 'ready': this.playTone(440, 'triangle', 0.3); break;
            case 'go': this.playTone(880, 'square', 0.5); break;
            case 'win': this.playTone(523, 'sine', 0.1); setTimeout(()=>this.playTone(659, 'sine', 0.1), 100); break;
        }
    }
};

const app = {
    init: function() {
        if(PRE_CONFIG_URL) {
            AppState.settings.gasUrl = PRE_CONFIG_URL;
            document.getElementById('gas-url-status').innerText = "âœ… å·²é€éç¨‹å¼ç¢¼é–å®šé€£ç·š";
            document.getElementById('gas-url-status').style.color = "var(--success)";
            document.getElementById('gas-url-status').style.fontWeight = "bold";
        }
        for(let i=0; i<6; i++) AppState.groups.push({name: `ç¬¬${i+1}çµ„`, score:0, members:[]});
        this.loadLocal();
        this.renderDashboard();
    },

    auth: {
        loginAdmin: function() {
            if(document.getElementById('password-input').value === AppState.settings.password) {
                AppState.userMode = 'admin'; this.applyMode();
            } else alert("å¯†ç¢¼éŒ¯èª¤");
        },
        loginGuest: function() {
            AppState.userMode = 'guest'; this.applyMode();
            const list = document.getElementById('guest-group-list'); list.innerHTML='';
            AppState.groups.forEach(g => {
                const btn = document.createElement('button');
                btn.className = 'btn'; btn.style.width='100%'; btn.style.justifyContent='center'; btn.innerText=g.name;
                btn.onclick = () => { AppState.myGroup = g.name; document.getElementById('my-group-name').innerText=g.name; document.getElementById('modal-guest-select').classList.remove('open'); app.buzzer.enterStudentMode(); };
                list.appendChild(btn);
            });
            document.getElementById('modal-guest-select').classList.add('open');
            app.sync.startPolling(2000);
        },
        applyMode: function() {
            document.getElementById('login-overlay').style.display = 'none';
            if(AppState.userMode === 'guest') {
                document.body.classList.add('mode-guest');
                app.switchView('dashboard');
            } else {
                document.body.classList.remove('mode-guest');
                app.admin.renderManualGroups();
                if(AppState.settings.gasUrl) app.sync.pull();
            }
        }
    },

    loadLocal: function() {
        const d = localStorage.getItem('classDataV7');
        if(d) {
            const p = JSON.parse(d);
            AppState.groups = p.groups || [];
            if(p.settings) Object.assign(AppState.settings, p.settings);
            if(PRE_CONFIG_URL) AppState.settings.gasUrl = PRE_CONFIG_URL;
            AppState.buzzer = p.buzzer || {state:'idle', results:[]};
            this.updateUI();
        }
    },

    save: function() {
        if(AppState.userMode === 'guest') return;
        localStorage.setItem('classDataV7', JSON.stringify(AppState));
        this.sync.push();
    },

    updateUI: function() {
        document.getElementById('link-status').innerText = AppState.settings.linked ? 'ON' : 'OFF';
        document.getElementById('link-status').style.color = AppState.settings.linked ? 'var(--primary)' : 'var(--text-sec)';
    },
    
    toggleLink: function() { AppState.settings.linked = !AppState.settings.linked; this.updateUI(); this.save(); },
    toggleSound: function() { AppState.settings.sound = !AppState.settings.sound; this.save(); },
    
    switchView: function(v) {
        document.querySelectorAll('.view-section').forEach(e => e.classList.remove('active'));
        document.getElementById('view-'+v).classList.add('active');
        document.querySelectorAll('.nav-item').forEach(e => e.classList.remove('active'));
        const navBtn = document.getElementById('nav-'+v);
        if(navBtn) navBtn.classList.add('active');
        if(v === 'admin') app.admin.renderManualGroups();
    },

    scoreGroup: function(idx, delta) {
        if(AppState.userMode === 'guest') return;
        AppState.groups[idx].score += delta; AudioSys.play('click'); this.renderDashboard(); this.save();
    },
    scoreMember: function(gIdx, mIdx, delta) {
        if(AppState.userMode === 'guest') return;
        AppState.groups[gIdx].members[mIdx].score += delta;
        if(AppState.settings.linked) AppState.groups[gIdx].score += delta;
        AudioSys.play('click'); this.renderDashboard(); this.save();
    },

    renderDashboard: function() {
        const c = document.getElementById('groups-container'); c.innerHTML = '';
        const rankList = document.getElementById('buzzer-rank-list');
        
        // Update Buzzer Panel Info
        document.getElementById('admin-buzzer-state').innerText = AppState.buzzer.state.toUpperCase();
        if(AppState.buzzer.results.length > 0) {
            let html = '';
            AppState.buzzer.results.forEach((r,i) => html += `<span style="margin:0 10px;">#${i+1} ${r.groupName}</span>`);
            rankList.innerHTML = html;
        } else {
            rankList.innerHTML = '<span style="color:#999; font-weight:normal;">å°šç„¡æ¶ç­”çµæœ</span>';
        }

        // Cards
        AppState.groups.forEach((g, gIdx) => {
            let mHtml = '';
            g.members.forEach((m, mIdx) => {
                mHtml += `<div class="member-row"><span class="member-name">${m.name}</span><div style="display:flex; gap:5px;"><button class="btn-circle" style="width:24px; height:24px; font-size:1rem;" onclick="app.scoreMember(${gIdx},${mIdx},-1)">-</button><span class="member-score">${m.score}</span><button class="btn-circle" style="width:24px; height:24px; font-size:1rem; color:var(--primary);" onclick="app.scoreMember(${gIdx},${mIdx},1)">+</button></div></div>`;
            });

            const rank = AppState.buzzer.results.findIndex(r => r.groupName === g.name);
            let borderStyle = '';
            if(rank === 0) borderStyle = 'border: 2px solid #FFD60A; box-shadow: 0 0 15px rgba(255, 214, 10, 0.4);';

            const div = document.createElement('div');
            div.className = 'glass group-card';
            if(borderStyle) div.style.cssText += borderStyle;
            div.innerHTML = `
                <div class="group-header">
                    <span class="group-name">${g.name}</span>
                    <div style="display:flex; align-items:center; gap:8px;">
                        <button class="btn-circle" onclick="app.scoreGroup(${gIdx}, -1)">-</button>
                        <span class="score-display">${g.score}</span>
                        <button class="btn-circle" style="color:var(--primary);" onclick="app.scoreGroup(${gIdx}, 1)">+</button>
                    </div>
                </div>
                <div class="member-list">${mHtml}</div>
            `;
            c.appendChild(div);
        });

        if(AppState.userMode === 'guest') app.buzzer.updateStudentScreen();
    },

    buzzer: {
        set: function(s) {
            AppState.buzzer.state = s;
            if(s==='idle') AppState.buzzer.results=[];
            if(s==='ready') AudioSys.play('ready'); if(s==='go') AudioSys.play('go');
            app.save(); app.renderDashboard();
        },
        enterStudentMode: function() { document.getElementById('student-buzzer-screen').style.display='flex'; this.updateStudentScreen(); },
        exitStudentMode: function() { document.getElementById('student-buzzer-screen').style.display='none'; },
        updateStudentScreen: function() {
            const txt = document.getElementById('buzzer-status-text');
            const btn = document.getElementById('buzzer-btn');
            const s = AppState.buzzer.state;
            
            if(s === 'idle') { txt.innerText = "è€å¸«æº–å‚™ä¸­..."; btn.style.display='none'; }
            else if(s === 'ready') { txt.innerText = "âœ‹ é å‚™..."; btn.style.display='none'; }
            else if(s === 'go') {
                const myRes = AppState.buzzer.results.find(r => r.groupName === AppState.myGroup);
                if(myRes) {
                    txt.innerText = `æ’å: ç¬¬ ${AppState.buzzer.results.indexOf(myRes)+1} å`;
                    btn.style.display='none';
                } else {
                    txt.innerText = "ğŸ”¥ æ¶ç­”ï¼";
                    btn.style.display='block';
                }
            }
        },
        studentBuzz: function() {
            if(!AppState.settings.gasUrl) return alert('æœªé€£ç·š');
            document.getElementById('buzzer-btn').style.display='none';
            document.getElementById('buzzer-status-text').innerText = "å‚³é€ä¸­...";
            fetch(AppState.settings.gasUrl, {
                method: 'POST', mode: 'no-cors', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ action: 'buzz', groupName: AppState.myGroup, timestamp: Date.now() })
            }).then(() => setTimeout(() => app.sync.pull(), 500));
        }
    },

    admin: {
        renderManualGroups: function() {
            const c = document.getElementById('manual-group-container'); c.innerHTML='';
            AppState.groups.forEach((g,idx) => {
                const names = g.members.map(m=>m.name).join('\n');
                const div = document.createElement('div');
                div.className='manual-group-item';
                div.innerHTML = `
                    <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                        <input type="text" value="${g.name}" id="gn-${idx}" style="border:none; background:transparent; font-weight:bold; border-bottom:1px solid #999; width:120px; font-size:1.1rem;">
                        <button class="btn danger" style="padding:6px 10px; font-size:0.8rem;" onclick="app.admin.deleteGroup(${idx})">åˆªé™¤æœ¬çµ„</button>
                    </div>
                    <textarea class="form-control" id="gt-${idx}" style="height:80px; background:rgba(255,255,255,0.8);">${names}</textarea>
                `;
                c.appendChild(div);
            });
        },
        addGroup: function() { AppState.groups.push({name:`æ–°çµ„åˆ¥`, score:0, members:[]}); this.renderManualGroups(); },
        deleteGroup: function(idx) { if(confirm("ç¢ºå®šåˆªé™¤æ­¤çµ„ï¼Ÿ")) { AppState.groups.splice(idx,1); this.renderManualGroups(); } },
        saveManualGroups: function() {
            try {
                AppState.groups.forEach((g,idx) => {
                    const nameInput = document.getElementById(`gn-${idx}`);
                    const memberInput = document.getElementById(`gt-${idx}`);
                    if(nameInput && memberInput) {
                        g.name = nameInput.value;
                        const text = memberInput.value;
                        g.members = text.split('\n').map(n=>n.trim()).filter(n=>n).map(n=>{
                            const exist = g.members.find(old=>old.name===n);
                            return {name:n, score: exist?exist.score:0};
                        });
                    }
                });
                app.renderDashboard(); 
                app.save(); 
                app.toast("âœ… è¨­å®šå·²å„²å­˜");
            } catch(e) { console.error(e); alert("å„²å­˜æ™‚ç™¼ç”ŸéŒ¯èª¤"); }
        },
        autoRandomGroup: function() {
            if(!confirm("é‡æ–°éš¨æ©Ÿåˆ†çµ„ï¼Ÿç¾æœ‰åˆ†çµ„å°‡è¢«è¦†è“‹ï¼")) return;
            const names = document.getElementById('bulk-names').value.split('\n').map(n=>n.trim()).filter(n=>n);
            const count = parseInt(document.getElementById('group-count').value)||6;
            if(!names.length) return alert('è«‹è¼¸å…¥åå–®');
            for(let i=names.length-1; i>0; i--) { const j=Math.floor(Math.random()*(i+1)); [names[i],names[j]]=[names[j],names[i]]; }
            const newG = []; for(let i=0; i<count; i++) newG.push({name:`ç¬¬${i+1}çµ„`, score:0, members:[]});
            names.forEach((n,i) => newG[i%count].members.push({name:n, score:0}));
            AppState.groups = newG; this.renderManualGroups(); app.renderDashboard(); app.save(); app.toast("å·²éš¨æ©Ÿåˆ†çµ„");
        },
        exportCSV: function() {
             let csv = "\uFEFFçµ„åˆ¥,å§“å,å€‹äººåˆ†,çµ„ç¸½åˆ†\n";
             AppState.groups.forEach(g => { g.members.forEach(m => csv += `${g.name},${m.name},${m.score},${g.score}\n`); });
             const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([csv], {type:'text/csv'})); a.download = 'æˆç¸¾å–®.csv'; a.click();
        }
    },

    sync: {
        timer: null,
        startPolling: function(ms=5000) { if(this.timer) clearInterval(this.timer); this.timer = setInterval(()=>{if(AppState.settings.gasUrl)app.sync.pull()}, ms); if(AppState.settings.gasUrl)app.sync.pull(); },
        manualSync: function() { app.save(); app.sync.pull(); app.toast("åŒæ­¥ä¸­..."); },
        push: function() {
            if(!AppState.settings.gasUrl) return;
            fetch(AppState.settings.gasUrl, { method: 'POST', mode: 'no-cors', headers:{'Content-Type':'application/json'}, body: JSON.stringify({action:'save', data:AppState}) });
        },
        pull: function() {
            if(!AppState.settings.gasUrl) return;
            const dot = document.getElementById('conn-dot');
            fetch(AppState.settings.gasUrl + '?action=read', {method:'GET', redirect:'follow'})
            .then(r=>r.json()).then(d => {
                if(d && d.groups) {
                    if(d.buzzer) AppState.buzzer = d.buzzer;
                    AppState.groups = d.groups;
                    if(d.settings && d.settings.linked!==undefined) AppState.settings.linked = d.settings.linked;
                    app.renderDashboard(); 
                    if(AppState.userMode==='admin' && document.activeElement.tagName !== 'TEXTAREA' && document.activeElement.tagName !== 'INPUT') {
                        app.admin.renderManualGroups();
                    }
                    app.updateUI();
                    dot.classList.add('ok');
                }
            }).catch(e => dot.classList.remove('ok'));
        }
    },

    lottery: {
        start: function(mode) {
            document.querySelector('.fab-menu').style.display='none'; app.switchView('dashboard');
            let t = []; if(mode==='group') t=AppState.groups.map(g=>g.name); else AppState.groups.forEach(g=>g.members.forEach(m=>t.push(m.name)));
            if(!t.length) return alert('ç„¡åå–®');
            let c=0, max=20, idx=0;
            const step = () => {
                idx = (idx+1)%t.length; document.getElementById('winner-name').innerText = t[idx]; AudioSys.play('click');
                document.getElementById('modal-winner').classList.add('open');
                if(++c<max) setTimeout(step, 50+(c*10)); else AudioSys.play('win');
            }
            step();
        }
    },
    
    toast: function(msg) {
        const t = document.getElementById('toast');
        t.innerHTML = msg;
        t.style.opacity = 1; t.style.top = '30px';
        setTimeout(() => { t.style.opacity=0; t.style.top='20px'; }, 2000);
    }
};

window.app = app;
app.init();
</script>
</body>
</html>