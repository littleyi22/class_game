<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¥•éˆè€å¸«çš„åœ‹æ–‡èª² - é›²ç«¯åˆ†çµ„æ§åˆ¶å° v4</title>
    <style>
        :root {
            --primary: #2563eb; 
            --secondary: #059669;
            --accent: #f59e0b;
            --danger: #dc2626;
            --bg: #f8fafc;
            --card-bg: #ffffff;
            --highlight: #ef4444;
        }

        * { box-sizing: border-box; font-family: 'Microsoft JhengHei', 'Segoe UI', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; padding: 0; background-color: var(--bg); color: #1e293b; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

        /* HEADER */
        header {
            background: var(--card-bg); padding: 0.8rem 1rem; display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05); z-index: 50; flex-shrink: 0;
        }
        .brand { font-size: 1.1rem; font-weight: 800; color: var(--primary); display: flex; align-items: center; gap: 8px; }
        .controls { display: flex; gap: 8px; }
        
        .toggle-btn {
            background: #e2e8f0; border: none; padding: 0.4rem 0.8rem; border-radius: 20px;
            font-size: 0.8rem; font-weight: 600; cursor: pointer; transition: 0.2s; display: flex; align-items: center; gap: 4px;
        }
        .toggle-btn.active { background: var(--primary); color: white; }
        .toggle-btn.active-green { background: var(--secondary); color: white; }

        /* NAV */
        nav { background: #e2e8f0; display: flex; justify-content: center; gap: 0.5rem; padding: 0.4rem; flex-shrink: 0; }
        .nav-item {
            padding: 0.4rem 1.2rem; border: none; background: transparent; 
            font-weight: 600; color: #64748b; cursor: pointer; border-radius: 6px;
        }
        .nav-item.active { background: var(--card-bg); color: var(--primary); box-shadow: 0 1px 2px rgba(0,0,0,0.1); }

        /* GUEST MODE STYLES */
        body.mode-guest .admin-only { display: none !important; }
        body.mode-guest .score-control button { display: none !important; }
        body.mode-guest .fab-container { display: none !important; }

        /* MAIN CONTENT */
        main { flex: 1; overflow-y: auto; padding: 1rem; position: relative; scroll-behavior: smooth; }
        .view-section { display: none; padding-bottom: 80px; }
        .view-section.active { display: block; animation: fadeIn 0.3s; }

        /* DASHBOARD GRID */
        .dashboard-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1rem;
        }
        .group-card {
            background: var(--card-bg); border-radius: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            overflow: hidden; border-top: 4px solid var(--primary); display: flex; flex-direction: column;
            transition: transform 0.2s; border: 3px solid transparent;
        }
        .group-card.lottery-active {
            border-color: var(--highlight); box-shadow: 0 0 15px var(--highlight); transform: scale(1.02); z-index: 10;
        }

        .group-header {
            padding: 0.8rem; background: #f1f5f9; border-bottom: 1px solid #e2e8f0;
            display: flex; justify-content: space-between; align-items: center;
        }
        .group-name { font-weight: 700; font-size: 1.1rem; }
        .score-control { display: flex; align-items: center; gap: 5px; }
        .score-display { font-size: 1.3rem; font-weight: 800; color: var(--primary); min-width: 40px; text-align: center; }
        
        .btn-circle {
            width: 28px; height: 28px; border-radius: 50%; border: none; cursor: pointer;
            display: flex; align-items: center; justify-content: center; font-size: 1.1rem; font-weight: bold;
            transition: 0.1s;
        }
        .btn-circle:active { transform: scale(0.9); }
        .btn-minus { background: #fee2e2; color: var(--danger); }
        .btn-plus { background: #dbeafe; color: var(--primary); }

        /* MEMBER ROWS */
        .member-list { padding: 0.5rem; flex: 1; }
        .member-row {
            display: flex; justify-content: space-between; align-items: center;
            padding: 0.5rem; border-radius: 6px; border-bottom: 1px solid #f1f5f9;
            border: 2px solid transparent; 
        }
        .member-row:last-child { border-bottom: none; }
        .member-row.lottery-active {
            border-color: var(--highlight); background: #fff1f2;
        }
        .member-name { font-weight: 500; font-size: 1rem; color: #334155; }
        .member-score { font-size: 1.1rem; font-weight: 700; color: #64748b; width: 30px; text-align: center;}

        /* ADMIN STYLES */
        .admin-box { background: white; padding: 1.5rem; border-radius: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); margin-bottom: 1.5rem; }
        .admin-section-title { border-left: 4px solid var(--primary); padding-left: 10px; margin-top: 0; margin-bottom: 1rem; color: #1e293b; }
        .form-control { width: 100%; padding: 10px; border: 1px solid #cbd5e1; border-radius: 8px; font-size: 1rem; margin-bottom: 10px; }
        textarea.form-control { resize: vertical; min-height: 120px; font-family: inherit; }
        
        .manual-group-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem; margin-top: 1rem; }
        .manual-group-item { background: #f8fafc; padding: 10px; border-radius: 8px; border: 1px solid #e2e8f0; }
        .manual-group-header { display: flex; justify-content: space-between; margin-bottom: 5px; font-weight: bold; font-size: 0.9rem; }

        /* FAB & MODALS */
        .fab-container {
            position: fixed; bottom: 20px; right: 20px; display: flex; flex-direction: column-reverse; gap: 10px; z-index: 100;
        }
        .fab-main {
            width: 60px; height: 60px; border-radius: 30px; background: var(--accent); color: white;
            border: none; box-shadow: 0 4px 10px rgba(0,0,0,0.2); font-size: 24px; cursor: pointer;
            display: flex; align-items: center; justify-content: center; transition: transform 0.2s;
        }
        .fab-main:active { transform: scale(0.9); }
        .fab-menu {
            display: none; flex-direction: column; gap: 10px; align-items: flex-end;
        }
        .fab-container:hover .fab-menu, .fab-menu.show { display: flex; }
        .fab-item {
            background: white; color: #1e293b; padding: 10px 15px; border-radius: 20px; border: none;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1); font-weight: bold; cursor: pointer; display: flex; align-items: center; gap: 8px; white-space: nowrap;
        }
        .fab-item:hover { background: #f1f5f9; }

        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5);
            display: none; justify-content: center; align-items: center; z-index: 1000;
        }
        .modal-overlay.open { display: flex; animation: fadeIn 0.2s; }
        .modal { background: white; padding: 2rem; border-radius: 16px; width: 90%; max-width: 400px; text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
        
        /* LOGIN OVERLAY */
        #login-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #f1f5f9;
            z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .login-card {
            background: white; padding: 2.5rem; border-radius: 16px; box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            width: 90%; max-width: 380px; text-align: center;
        }
        .login-btn {
            width: 100%; padding: 12px; border-radius: 8px; border: none; font-weight: bold; font-size: 1rem; cursor: pointer; margin-top: 10px;
        }
        
        #toast {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            background: rgba(0,0,0,0.8); color: white; padding: 10px 20px; border-radius: 30px;
            font-size: 0.9rem; pointer-events: none; opacity: 0; transition: opacity 0.3s; z-index: 200;
        }
        .spinner { border: 3px solid #f3f3f3; border-top: 3px solid var(--primary); border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; display: none;}
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

<!-- LOGIN OVERLAY -->
<div id="login-overlay">
    <div class="login-card">
        <h2 style="color: var(--primary); margin-top: 0;">ğŸ”’ èº«ä»½é©—è­‰</h2>
        <p style="color: #64748b; margin-bottom: 20px;">è«‹é¸æ“‡æ‚¨çš„ç™»å…¥èº«ä»½</p>
        
        <div style="margin-bottom: 20px;">
            <input type="password" id="password-input" class="form-control" placeholder="è«‹è¼¸å…¥è€å¸«å¯†ç¢¼" style="text-align: center;">
            <button class="login-btn" style="background: var(--primary); color: white;" onclick="app.auth.loginAdmin()">ğŸ‘¨â€ğŸ« è€å¸«ç™»å…¥</button>
        </div>
        
        <div style="border-top: 1px solid #e2e8f0; padding-top: 20px;">
            <button class="login-btn" style="background: #e2e8f0; color: #475569;" onclick="app.auth.loginGuest()">ğŸ‘€ è¨ªå®¢æ¨¡å¼ (åƒ…è§€çœ‹)</button>
        </div>
    </div>
</div>

<header>
    <div class="brand">
        <span>ğŸ“š å¥•éˆè€å¸«çš„åˆ†çµ„èª²</span>
        <div id="sync-spinner" class="spinner" title="åŒæ­¥ä¸­..."></div>
    </div>
    <div class="controls admin-only">
        <button id="toggle-link" class="toggle-btn active" onclick="app.toggleLink()">
            ğŸ”„ åˆ†æ•¸é€£å‹• <span id="link-status">ON</span>
        </button>
        <button id="toggle-sound" class="toggle-btn active-green" onclick="app.toggleSound()">
            ğŸ”Š éŸ³æ•ˆ
        </button>
    </div>
    <div class="controls" id="guest-indicator" style="display:none;">
        <span style="font-size:0.8rem; background:#e2e8f0; padding:4px 8px; border-radius:4px; color:#64748b;">è¨ªå®¢æ¨¡å¼ (è‡ªå‹•æ›´æ–°ä¸­)</span>
    </div>
</header>

<nav class="admin-only">
    <button class="nav-item active" onclick="app.switchView('dashboard')">åˆ†çµ„çœ‹æ¿</button>
    <button class="nav-item" onclick="app.switchView('admin')">å¾Œå°è¨­å®š</button>
</nav>

<main>
    <!-- VIEW: DASHBOARD -->
    <section id="view-dashboard" class="view-section active">
        <div id="groups-container" class="dashboard-grid">
            <!-- Groups injected here -->
        </div>
    </section>

    <!-- VIEW: ADMIN (Hidden for Guest) -->
    <section id="view-admin" class="view-section admin-only">
        <!-- 1. å¿«é€Ÿéš¨æ©Ÿåˆ†çµ„ -->
        <div class="admin-box">
            <h3 class="admin-section-title">âš¡ å¿«é€Ÿéš¨æ©Ÿåˆ†çµ„</h3>
            <textarea id="bulk-names" class="form-control" placeholder="åœ¨æ­¤è²¼ä¸Šåå–®..."></textarea>
            <div style="display: flex; gap: 10px; align-items: center;">
                <label>åˆ†çµ„æ•¸ï¼š</label>
                <input type="number" id="group-count-bulk" value="6" min="1" max="12" style="width: 60px; padding: 8px; border:1px solid #ccc; border-radius:6px;">
                <button class="toggle-btn active" onclick="app.admin.autoRandomGroup()">ğŸ² åŸ·è¡Œåˆ†çµ„</button>
            </div>
        </div>
        <!-- 2. æ‰‹å‹•å¾®èª¿ -->
        <div class="admin-box">
            <h3 class="admin-section-title">ğŸ‘¥ æ‰‹å‹•åˆ†çµ„å¾®èª¿</h3>
            <div id="manual-group-container" class="manual-group-grid"></div>
            <button class="toggle-btn active" onclick="app.admin.saveManualGroups()" style="margin-top: 15px; width: 100%; justify-content: center; padding: 12px;">ğŸ’¾ å„²å­˜æ‰€æœ‰è¨­å®š</button>
        </div>
        <!-- 3. é›²ç«¯èˆ‡è³‡æ–™ -->
        <div class="admin-box">
            <h3 class="admin-section-title">â˜ï¸ é›²ç«¯åŒæ­¥èˆ‡è¨­å®š</h3>
            <div style="margin-bottom: 1rem;">
                <label style="display:block; margin-bottom:5px; font-weight:bold;">Google Apps Script ç¶²å€</label>
                <input type="text" id="gas-url" class="form-control" placeholder="https://script.google.com/..." onchange="app.save()">
            </div>
            <div style="margin-bottom: 1rem;">
                <label style="display:block; margin-bottom:5px; font-weight:bold;">ä¿®æ”¹è€å¸«å¯†ç¢¼</label>
                <input type="text" id="admin-pass-setter" class="form-control" placeholder="é è¨­: 1234">
                <button class="toggle-btn" onclick="app.auth.updatePassword()">æ›´æ–°å¯†ç¢¼</button>
            </div>
            <div style="display: flex; gap: 10px; margin-top: 20px; border-top:1px solid #eee; padding-top:10px;">
                <button class="toggle-btn" style="background: #64748b; color: white;" onclick="app.admin.resetScores()">æ­¸é›¶åˆ†æ•¸</button>
                <button class="toggle-btn" style="background: #059669; color: white;" onclick="app.admin.exportCSV()">åŒ¯å‡º Excel</button>
            </div>
        </div>
    </section>
</main>

<!-- FLOATING LOTTERY (Hidden for Guest) -->
<div class="fab-container admin-only">
    <button class="fab-main" onclick="document.querySelector('.fab-menu').classList.toggle('show')">ğŸ²</button>
    <div class="fab-menu">
        <button class="fab-item" onclick="app.lottery.start('group')">ğŸ° æŠ½å°çµ„</button>
        <button class="fab-item" onclick="app.lottery.start('person')">ğŸ‘¤ æŠ½å€‹äºº</button>
        <button class="fab-item" onclick="app.lottery.start('person-in-group')">ğŸ¯ æŒ‡å®šçµ„å…§</button>
    </div>
</div>

<!-- MODALS -->
<div id="modal-winner" class="modal-overlay" onclick="this.classList.remove('open')">
    <div class="modal" onclick="event.stopPropagation()">
        <div style="font-size: 3rem;">ğŸ‰</div>
        <h3>å¹¸é‹å¾—ä¸»</h3>
        <div id="winner-name" class="winner-text">---</div>
        <button class="toggle-btn active" style="margin: 0 auto;" onclick="document.getElementById('modal-winner').classList.remove('open')">ç¢ºå®š</button>
    </div>
</div>
<div id="modal-group-select" class="modal-overlay">
    <div class="modal">
        <h3>è«‹é¸æ“‡è¦æŠ½ç±¤çš„çµ„åˆ¥</h3>
        <div id="group-select-list" style="display:flex; flex-direction:column; gap:8px; max-height:300px; overflow-y:auto; margin:15px 0;"></div>
        <button class="toggle-btn" onclick="document.getElementById('modal-group-select').classList.remove('open')">å–æ¶ˆ</button>
    </div>
</div>
<div id="toast"></div>

<script>
/**
 * å¥•éˆè€å¸«çš„åœ‹æ–‡èª² - æ ¸å¿ƒé‚è¼¯ v4 (Security & Guest Mode)
 */

const AppState = {
    groups: [],
    settings: { linked: true, sound: true, gasUrl: '', password: '1234' },
    userMode: 'guest' // 'admin' or 'guest'
};

const AudioSys = {
    ctx: null,
    playTone: function(freq, type, dur) {
        if (!AppState.settings.sound) return;
        if (!this.ctx) this.ctx = new (window.AudioContext || window.webkitAudioContext)();
        const o = this.ctx.createOscillator();
        const g = this.ctx.createGain();
        o.type = type; o.frequency.value = freq;
        g.gain.setValueAtTime(0.1, this.ctx.currentTime);
        g.gain.exponentialRampToValueAtTime(0.001, this.ctx.currentTime + dur);
        o.connect(g); g.connect(this.ctx.destination);
        o.start(); o.stop(this.ctx.currentTime + dur);
    },
    play: function(key) {
        // Guest mode usually silent unless lottery runs? keeping it simple
        if(AppState.userMode === 'guest' && key !== 'win') return; 
        switch(key) {
            case 'tick': this.playTone(400, 'square', 0.05); break;
            case 'win': this.playTone(523, 'sine', 0.1); setTimeout(()=>this.playTone(659, 'sine', 0.1), 100); setTimeout(()=>this.playTone(784, 'sine', 0.3), 200); break;
            case 'click': this.playTone(800, 'sine', 0.08); break;
        }
    }
};

const app = {
    init: function() {
        for(let i=0; i<6; i++) AppState.groups.push({name: `ç¬¬${i+1}çµ„`, score:0, members:[]});
        this.loadLocal();
        this.renderDashboard();
    },

    auth: {
        loginAdmin: function() {
            const input = document.getElementById('password-input').value;
            if (input === AppState.settings.password) {
                AppState.userMode = 'admin';
                app.auth.applyMode();
            } else {
                alert("å¯†ç¢¼éŒ¯èª¤ï¼");
            }
        },
        loginGuest: function() {
            AppState.userMode = 'guest';
            app.auth.applyMode();
            // Start Auto-Polling for Guest
            app.sync.startPolling(); 
        },
        applyMode: function() {
            document.getElementById('login-overlay').style.display = 'none';
            if (AppState.userMode === 'guest') {
                document.body.classList.add('mode-guest');
                document.getElementById('guest-indicator').style.display = 'flex';
                // Switch to dashboard incase they were on admin
                app.switchView('dashboard');
            } else {
                document.body.classList.remove('mode-guest');
                document.getElementById('guest-indicator').style.display = 'none';
                app.admin.renderManualGroups();
                // Check if GAS URL is needed
                if (AppState.settings.gasUrl) app.sync.pull();
            }
        },
        updatePassword: function() {
            const newPass = document.getElementById('admin-pass-setter').value.trim();
            if(newPass) {
                AppState.settings.password = newPass;
                app.save();
                app.toast("å¯†ç¢¼å·²æ›´æ–°");
            }
        }
    },

    loadLocal: function() {
        const d = localStorage.getItem('classDataV4');
        if (d) {
            const p = JSON.parse(d);
            AppState.groups = p.groups || [];
            AppState.settings = Object.assign(AppState.settings, p.settings); // merge settings
            document.getElementById('gas-url').value = AppState.settings.gasUrl || '';
            document.getElementById('admin-pass-setter').value = AppState.settings.password;
            this.updateUI();
        }
    },

    save: function() {
        if (AppState.userMode === 'guest') return; // Guests can't save
        AppState.settings.gasUrl = document.getElementById('gas-url').value.trim();
        localStorage.setItem('classDataV4', JSON.stringify(AppState));
        this.sync.push(); 
    },

    updateUI: function() {
        document.getElementById('link-status').innerText = AppState.settings.linked ? 'ON' : 'OFF';
        document.getElementById('toggle-link').className = `toggle-btn ${AppState.settings.linked ? 'active' : ''}`;
        document.getElementById('toggle-sound').className = `toggle-btn ${AppState.settings.sound ? 'active-green' : ''}`;
    },

    toggleLink: function() { AppState.settings.linked = !AppState.settings.linked; this.updateUI(); this.save(); },
    toggleSound: function() { AppState.settings.sound = !AppState.settings.sound; this.updateUI(); this.save(); },
    switchView: function(v) {
        document.querySelectorAll('.view-section').forEach(e => e.classList.remove('active'));
        document.getElementById('view-'+v).classList.add('active');
        document.querySelectorAll('.nav-item').forEach(e => e.classList.remove('active'));
        if (event) event.target.classList.add('active');
        if(v === 'admin' && AppState.userMode === 'admin') app.admin.renderManualGroups();
    },

    // --- Scoring ---
    scoreGroup: function(idx, delta) {
        if (AppState.userMode === 'guest') return;
        AppState.groups[idx].score += delta;
        AudioSys.play('click');
        this.renderDashboard(); this.save();
    },
    scoreMember: function(gIdx, mIdx, delta) {
        if (AppState.userMode === 'guest') return;
        AppState.groups[gIdx].members[mIdx].score += delta;
        if (AppState.settings.linked) AppState.groups[gIdx].score += delta;
        AudioSys.play('click');
        this.renderDashboard(); this.save();
    },

    renderDashboard: function() {
        const c = document.getElementById('groups-container');
        c.innerHTML = '';
        AppState.groups.forEach((g, gIdx) => {
            let mHtml = '';
            g.members.forEach((m, mIdx) => {
                mHtml += `
                <div class="member-row" id="m-${gIdx}-${mIdx}">
                    <span class="member-name">${m.name}</span>
                    <div class="score-control">
                        <button class="btn-circle btn-minus" onclick="app.scoreMember(${gIdx},${mIdx},-1)">-</button>
                        <span class="member-score">${m.score}</span>
                        <button class="btn-circle btn-plus" onclick="app.scoreMember(${gIdx},${mIdx},1)">+</button>
                    </div>
                </div>`;
            });

            const div = document.createElement('div');
            div.className = 'group-card';
            div.id = `g-${gIdx}`;
            div.innerHTML = `
                <div class="group-header">
                    <span class="group-name">${g.name}</span>
                    <div class="score-control">
                        <button class="btn-circle btn-minus" onclick="app.scoreGroup(${gIdx},-1)">-</button>
                        <span class="score-display">${g.score}</span>
                        <button class="btn-circle btn-plus" onclick="app.scoreGroup(${gIdx},1)">+</button>
                    </div>
                </div>
                <div class="member-list">${mHtml}</div>
            `;
            c.appendChild(div);
        });
    },

    // --- Sync ---
    sync: {
        timer: null,
        startPolling: function() {
            if (this.timer) clearInterval(this.timer);
            // Poll every 5 seconds if URL exists
            this.timer = setInterval(() => {
                if(AppState.settings.gasUrl) app.sync.pull();
            }, 5000);
            // Initial pull
            if(AppState.settings.gasUrl) app.sync.pull();
        },
        manualSync: function() { app.save(); app.sync.pull(); },
        push: function() {
            const url = AppState.settings.gasUrl;
            if (!url) return;
            document.getElementById('sync-spinner').style.display = 'block';
            fetch(url, {
                method: 'POST', mode: 'no-cors',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({action: 'save', data: AppState})
            }).then(() => {
                setTimeout(() => document.getElementById('sync-spinner').style.display = 'none', 1000);
            });
        },
        pull: function() {
            const url = AppState.settings.gasUrl;
            if (!url) return;
            document.getElementById('sync-spinner').style.display = 'block';
            fetch(url + '?action=read', { method: 'GET', redirect: 'follow' })
            .then(r => r.json())
            .then(data => {
                if(data && data.groups) {
                    // Only update data, preserve local password/settings if admin
                    AppState.groups = data.groups;
                    if (data.settings && data.settings.linked !== undefined) AppState.settings.linked = data.settings.linked;
                    
                    app.renderDashboard();
                    if(AppState.userMode === 'admin') app.admin.renderManualGroups();
                    app.updateUI();
                }
                document.getElementById('sync-spinner').style.display = 'none';
            })
            .catch(e => document.getElementById('sync-spinner').style.display = 'none');
        }
    },

    toast: function(msg) {
        const t = document.getElementById('toast');
        t.innerText = msg; t.style.opacity = 1;
        setTimeout(() => t.style.opacity = 0, 2000);
    },

    // --- Admin ---
    admin: {
        renderManualGroups: function() {
            const c = document.getElementById('manual-group-container');
            c.innerHTML = '';
            AppState.groups.forEach((g, idx) => {
                const names = g.members.map(m => m.name).join('\n');
                const div = document.createElement('div');
                div.className = 'manual-group-item';
                div.innerHTML = `
                    <div class="manual-group-header">
                        <input type="text" value="${g.name}" id="gn-${idx}" style="width:100px; padding:2px; border:1px solid #ddd; border-radius:4px;">
                        <span>(åˆ†: ${g.score})</span>
                    </div>
                    <textarea class="form-control" id="gt-${idx}" style="height:150px; margin-bottom:0;">${names}</textarea>
                `;
                c.appendChild(div);
            });
            document.getElementById('group-count-bulk').value = AppState.groups.length;
        },
        saveManualGroups: function() {
            AppState.groups.forEach((g, idx) => {
                const newName = document.getElementById(`gn-${idx}`).value;
                const text = document.getElementById(`gt-${idx}`).value;
                const newMembers = text.split(/\n/).map(n=>n.trim()).filter(n=>n).map(n => {
                    const exist = g.members.find(old => old.name === n);
                    return { name: n, score: exist ? exist.score : 0 };
                });
                g.name = newName; g.members = newMembers;
            });
            app.renderDashboard(); app.save(); app.toast("å„²å­˜æˆåŠŸ");
        },
        autoRandomGroup: function() {
            if(!confirm("ç¢ºå®šé‡æ–°åˆ†çµ„ï¼Ÿ")) return;
            const names = document.getElementById('bulk-names').value.split(/\r?\n/).map(n=>n.trim()).filter(n=>n);
            const count = parseInt(document.getElementById('group-count-bulk').value) || 6;
            if(!names.length) return;
            
            for (let i = names.length - 1; i > 0; i--) { const j = Math.floor(Math.random()*(i+1)); [names[i], names[j]] = [names[j], names[i]]; }
            const newGroups = [];
            for(let i=0; i<count; i++) newGroups.push({name:`ç¬¬${i+1}çµ„`, score:0, members:[]});
            names.forEach((n,i) => newGroups[i%count].members.push({name:n, score:0}));
            
            AppState.groups = newGroups;
            this.renderManualGroups(); app.renderDashboard(); app.save(); app.toast("å·²éš¨æ©Ÿåˆ†çµ„");
        },
        resetScores: function() {
            if(!confirm("æ­¸é›¶æ‰€æœ‰åˆ†æ•¸ï¼Ÿ")) return;
            AppState.groups.forEach(g => { g.score=0; g.members.forEach(m=>m.score=0); });
            app.save(); app.renderDashboard(); app.admin.renderManualGroups();
        },
        exportCSV: function() {
             let csv = "\uFEFFçµ„åˆ¥,å§“å,å€‹äººåˆ†,çµ„ç¸½åˆ†\n";
             AppState.groups.forEach(g => { g.members.forEach(m => csv += `${g.name},${m.name},${m.score},${g.score}\n`); });
             const a = document.createElement('a');
             a.href = URL.createObjectURL(new Blob([csv], {type:'text/csv'}));
             a.download = 'æˆç¸¾å–®.csv'; a.click();
        }
    },

    // --- Lottery ---
    lottery: {
        timer: null,
        start: function(mode) {
            document.querySelector('.fab-menu').classList.remove('show');
            app.switchView('dashboard');
            if (mode === 'person-in-group') { this.showGroupSelect(); return; }
            let targets = []; 
            if (mode === 'group') targets = AppState.groups.map((g, i) => ({ id: `g-${i}`, name: g.name }));
            else if (mode === 'person') AppState.groups.forEach((g, gi) => g.members.forEach((m, mi) => targets.push({ id: `m-${gi}-${mi}`, name: m.name })));
            this.runAnimation(targets);
        },
        showGroupSelect: function() {
            const list = document.getElementById('group-select-list');
            list.innerHTML = '';
            AppState.groups.forEach((g, i) => {
                const btn = document.createElement('button');
                btn.className = 'toggle-btn'; btn.style.width = '100%'; btn.style.padding = '10px'; btn.innerText = g.name;
                btn.onclick = () => {
                    document.getElementById('modal-group-select').classList.remove('open');
                    this.runAnimation(g.members.map((m, mi) => ({ id: `m-${i}-${mi}`, name: m.name })));
                };
                list.appendChild(btn);
            });
            document.getElementById('modal-group-select').classList.add('open');
        },
        runAnimation: function(targets) {
            if (!targets.length) { alert('åå–®ç‚ºç©º'); return; }
            document.querySelectorAll('.lottery-active').forEach(e => e.classList.remove('lottery-active'));
            let count = 0, max = 20 + Math.floor(Math.random()*10), speed = 80, idx = Math.floor(Math.random()*targets.length);
            const step = () => {
                const prev = document.getElementById(targets[idx].id); if(prev) prev.classList.remove('lottery-active');
                idx = (idx + 1) % targets.length;
                const next = document.getElementById(targets[idx].id);
                if(next) { next.classList.add('lottery-active'); next.scrollIntoView({behavior:"auto", block:"center"}); AudioSys.play('tick'); }
                count++;
                if (count < max) { if (count > max-8) speed+=60; setTimeout(step, speed); }
                else { AudioSys.play('win'); document.getElementById('winner-name').innerText = targets[idx].name; document.getElementById('modal-winner').classList.add('open'); }
            };
            step();
        }
    }
};

app.init();
</script>
</body>
</html>